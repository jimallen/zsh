# .agent.rules.md

# Celebrate GmbH Agent Rules for TS Projects

> **Version:** v1.0.23
> **Language:** TS
> **Auto-generated file** - Do not edit directly. Generated from base rules + TS-specific rules.
> **Source:** https://github.com/celebrate-gmbh/agent-rules
> **Generated:** 2025-08-29 12:31:27 UTC

<!-- Trigger release v1.0.9 -->

These are the foundational rules for all Celebrate GmbH projects. The base rules are now modularized into separate files that are automatically combined during the build process.


## Purpose

These rules ensure **maintainability**, **safety**, and **developer velocity**.  
- **MUST** rules are enforced via CI and lint/type tooling  
- **SHOULD** rules are strongly recommended and regularly reviewed in PRs
---

## Before Coding

- **BP-1 (MUST)** Ask for clarifying questions if any part of the task is ambiguous.
- **BP-2 (SHOULD)** Draft and validate an approach for non-trivial changes.
- **BP-3 (SHOULD)** If more than one approach exists, list pros/cons explicitly.
---

## While Coding (Common Rules)

- **C-1 (MUST)** Use TDD where practical: scaffold → failing test → implement.
- **C-2 (MUST)** Use domain language when naming functions/methods/classes.
- **C-3 (SHOULD NOT)** Use comments unless explaining non-obvious caveats. Prioritize self-documenting code.
- **C-4 (SHOULD NOT)** Extract functions/methods unless:
  - reused,
  - needed to isolate untestable logic,
  - or they drastically improve readability.
---

## Testing (Common Rules)

- **T-1 (MUST)** Separate unit tests from integration tests.
- **T-2 (SHOULD)** Favor integration tests over mocking.
- **T-3 (SHOULD)** Unit test complex logic (e.g. conditionals, transforms).
---

## Git Commit Hygiene

- **GH-1 (MUST)** Use [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0).
- **GH-2 (SHOULD NOT)** Reference Claude or Anthropic in commits.
- **GH-3 (MUST)** use main instead of master
---

## Function/Method Implementation Checklist

Evaluate every function/method with this list:

1. Is it easy to follow with no mental gymnastics?
2. Does it avoid deep nesting or high cyclomatic complexity?
3. Can common data structures simplify it?
4. Are any parameters unused?
5. Can any type coercion be moved to parameters?
6. Is it testable in isolation or via integration test?
7. Are there hidden unmocked side effects?
8. Try 3 better names. Is the current name still best?

**Refactor only if:**
- Used in >1 place
- Needed for unit testing
- Original function/method requires excessive inline explanation
---

## Test Quality Checklist

Evaluate all tests against this:

1. **SHOULD** parameterize inputs; no magic numbers.
2. **SHOULD NOT** write trivial tests.
3. **SHOULD** match test name to assertion meaning.
4. **SHOULD** compare to known truths, not self-verified outputs.
5. **SHOULD** follow language-specific lint/style rules.
6. **SHOULD** use strong assertions (language-specific equivalents).
7. Test:
   - edge cases
   - realistic input
   - invalid input
   - boundaries
8. Don't test things the type system already enforces.
---

## Documentation

- **D-1 (MUST)** Create and maintain a `/docs` directory with system architecture documentation
- **D-2 (MUST)** Include a mermaid chart with an up-to-date system diagram in `/docs/system-architecture.md`
- **D-3 (MUST)** Add a link to the system architecture diagram in the README
- **D-4 (SHOULD)** Keep documentation in sync with code changes
- **D-5 (SHOULD)** Use mermaid diagrams for visual representations of complex systems
---

---

## While Coding (TypeScript-Specific)

- **C-TS1 (SHOULD NOT)** Use `class` when small testable functions suffice.
- **C-TS2 (SHOULD)** Prefer pure, composable, and testable functions.
- **C-TS3 (MUST)** Use **branded types** for identifiers:
  ```ts
  type UserId = Brand<string, 'UserId'>   // ✅ Good
  type UserId = string                    // ❌ Bad
  ```
- **C-TS4 (MUST)** Use `import type` for type-only imports:
  ```ts
  import type { User } from './types';
  ```
- **C-TS5 (SHOULD)** Use `type` by default; prefer `interface` only for readability or declaration merging.
---

## Testing (TypeScript-Specific)

- **T-TS1 (MUST)** Colocate unit tests with source using `*.spec.ts` files.
- **T-TS2 (MUST)** For API changes, extend tests under `packages/api/test/*.spec.ts`.
- **T-TS3 (SHOULD)** Use holistic assertions:
  ```ts
  expect(result).toEqual([value]); // ✅
  // ❌ Avoid breaking assertions into multiple lines:
  // expect(result).toHaveLength(1);
  // expect(result[0]).toBe(value);
  ```

- **T-TS4 (SHOULD)** Assert domain invariants using `fast-check`:
  ```ts
  import fc from 'fast-check';
  
  describe('getCharacterCount', () => {
    test('is additive', () => {
      fc.assert(
        fc.property(fc.string(), fc.string(), (a, b) => {
          return getCharacterCount(a + b) === getCharacterCount(a) + getCharacterCount(b);
        })
      );
    });
  });
  ```
- **T-TS5 (SHOULD)** Group tests under `describe(functionName, () => …)`.
- **T-TS6 (SHOULD)** Use `expect.any(...)` for flexible types (e.g. UUIDs).
- **T-TS7 (SHOULD NOT)** Test things the TypeScript compiler already enforces (e.g., types).
---

## Database (TypeScript-Specific)

- **D-TS1 (MUST)** Type DB functions as `KyselyDatabase | Transaction<Database>` to ensure compatibility across transactions.
- **D-TS2 (SHOULD)** Override incorrect types in `packages/shared/src/db-types.override.ts`.
---

## Code Organization (TypeScript-Specific)

- **O-TS1 (MUST)** Only add to `packages/shared` if used by ≥ 2 packages.
---

## Tooling Gates (TypeScript-Specific)

- **G-TS1 (MUST)** Pass `prettier --check`.
- **G-TS2 (MUST)** Pass `turbo typecheck lint` (includes `tsc`, `eslint`, and typegen).

Example scripts in `package.json`:
```json
{
  "scripts": {
    "lint": "eslint . --ext .ts,.tsx",
    "typecheck": "tsc --noEmit",
    "format": "prettier --write .",
    "check": "prettier --check .",
    "test": "vitest run"
  }
}
```
---

## TypeScript Test Quality Specifics

- **TQ-TS1 (SHOULD NOT)** Use `@ts-expect-error` to bypass lint rules.
- **TQ-TS2 (SHOULD)** Use strong assertions (`toEqual`, not `toBeGreaterThan`).
---

## Codebase Structure

```text
packages/
  ├── api/                  # Fastify server
  │   └── src/publisher/    # Platform-specific integrations
  ├── api-schema/           # Shared contracts (TypeBox)
  ├── shared/               # Utilities and types used by ≥2 packages
  │   └── social.ts         # Domain-specific logic (e.g., char count)
  └── web/                  # Next.js 15 app with App Router
```
---

